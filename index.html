// --- FUNGSI IMPORT YANG SUDAH DIOPTIMALKAN (ROBUST & SUPPORT >500 DATA) ---
const handleImportCSV = async (e) => {
    const file = e.target.files[0];
    if (!file || !confirm(`Import "${file.name}" ke database?`)) return;

    setImporting(true);
    const reader = new FileReader();

    reader.onload = async (ev) => {
        const content = ev.target.result;
        const lines = content.split(/\r\n|\n/).filter(line => line.trim() !== "");
        
        if (lines.length === 0) {
            alert("File kosong!");
            setImporting(false);
            return;
        }

        // 1. Deteksi Separator yang lebih kuat
        const firstLine = lines[0];
        const separator = firstLine.includes(";") ? ";" : ",";

        let importedCount = 0;
        let batch = writeBatch(db);
        let operationInBatch = 0;

        try {
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const cols = line.split(separator).map(c => c.replace(/^"|"$/g, '').trim());
                
                let name = cols[0];
                if (!name) continue;

                // 2. Skip Header
                const isHeader = name.toLowerCase() === 'nama' || name.toLowerCase().includes('name');
                if (isHeader) continue;

                // 3. Cek Duplikat lokal (case-insensitive)
                const isDuplicate = participants.some(p => p.name.toLowerCase() === name.toLowerCase());
                if (isDuplicate) continue;

                // 4. Siapkan Dokumen Baru
                const ref = doc(collection(db, COLLECTION_NAME));
                batch.set(ref, {
                    name: name,
                    category: cols[1] || "-",
                    kelas: cols[2] || "-",
                    regNum: `GSM-${Math.floor(1000 + Math.random() * 8999)}`, // ID unik 4 digit
                    checkedIn: false,
                    checkInTime: null,
                    createdAt: serverTimestamp()
                });

                importedCount++;
                operationInBatch++;

                // 5. CHUNKING: Firebase Batch limit adalah 500. 
                // Kita commit setiap 450 operasi untuk keamanan.
                if (operationInBatch >= 450) {
                    await batch.commit();
                    batch = writeBatch(db); // Reset batch baru
                    operationInBatch = 0;
                }
            }

            // Commit sisa data yang belum ter-commit
            if (operationInBatch > 0) {
                await batch.commit();
            }

            alert(`Berhasil mengimport ${importedCount} data peserta baru.`);
        } catch (error) {
            console.error("Import Error:", error);
            alert("Terjadi kesalahan saat import data.");
        } finally {
            setImporting(false);
            e.target.value = null; // Reset input file
        }
    };

    reader.readAsText(file);
};
