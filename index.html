<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sermon GSM GKPS Tangerang</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/qr-scanner@1.4.2/qr-scanner.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { primary: '#4f46e5', secondary: '#8b5cf6', accent: '#06b6d4' },
                    animation: {
                        'blob': 'blob 7s infinite',
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.5s ease-out',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'flash': 'flash 0.5s ease-out',
                    },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        },
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        flash: { '0%': { opacity: '0.8', backgroundColor: 'white' }, '100%': { opacity: '0', backgroundColor: 'transparent' } }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #f3f4f6;
            background-image: radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            background-attachment: fixed;
            background-size: cover;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .glass-nav {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border-top: 1px solid rgba(255, 255, 255, 0.5);
        }
        .scan-container {
            position: relative; width: 100%; height: 380px; overflow: hidden;
            border-radius: 1.5rem; background: #000;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .scan-video { width: 100%; height: 100%; object-fit: cover; }
        .scan-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(circle, transparent 65%, rgba(0,0,0,0.8) 100%); pointer-events: none;
        }
        .scan-flash {
            position: absolute; inset: 0; pointer-events: none; z-index: 50;
        }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* PERBAIKAN PRINT PREVIEW */
        @media print {
            @page { size: auto; margin: 5mm; }
            body { 
                background: white !important; 
                background-image: none !important; 
                color: black !important;
                margin: 0;
                padding: 0;
            }
            #root > *:not(.print-screen) { display: none !important; }
            .no-print { display: none !important; }
            .print-screen { 
                display: block !important; 
                position: static !important;
                background: white !important;
                width: 100% !important;
                height: auto !important;
            }
            .glass-panel { background: white !important; border: 1px solid #eee !important; backdrop-filter: none !important; }
            .page-break { page-break-inside: avoid; break-inside: avoid; margin-bottom: 10px; }
        }
    </style>
</head>
<body class="text-gray-800 font-sans antialiased min-h-screen selection:bg-indigo-500 selection:text-white">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js';
        import { getFirestore, collection, addDoc, onSnapshot, query, updateDoc, doc, serverTimestamp, deleteDoc, writeBatch, enableIndexedDbPersistence, setDoc, getDoc, getDocs } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js';
        import { QrCode, Users, CheckCircle, Search, Download, Trash2, Plus, Lock, LogOut, Camera, AlertCircle, RefreshCw, FileUp, User, LogIn, UserCog, CameraOff, List, Printer, AlertTriangle, KeyRound, Sparkles, ShieldCheck, PieChart, BarChart3, XCircle, FileSpreadsheet, FileText, TrendingUp, Filter, LayoutList, X, CalendarDays, TableProperties, LineChart, ChevronDown, Briefcase, Archive } from 'https://esm.sh/lucide-react@0.292.0';

        const firebaseConfig = {
            apiKey: "AIzaSyDrCRqotIf-eqwFmMx9kpDUCOUcTzJ8WGs",
            authDomain: "sermongsmgkpstangerang-77b63.firebaseapp.com",
            databaseURL: "https://sermongsmgkpstangerang-77b63-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "sermongsmgkpstangerang-77b63",
            storageBucket: "sermongsmgkpstangerang-77b63.firebasestorage.app",
            messagingSenderId: "987409950584",
            appId: "1:987409950584:web:b6792a69050f673c6eca8d",
            measurementId: "G-GE3FRB9D54"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        enableIndexedDbPersistence(db).catch(err => console.log("Persistence warning:", err.code));

        const COLLECTION_NAME = 'gkps_participants';
        const CONFIG_COLLECTION = 'gkps_config';
        const SCANNERS_COLLECTION = 'gkps_scanners';
        const LOGS_COLLECTION = 'gkps_attendance_logs';
        const MASTER_RESET_CODE = "GKPS2026"; 

        const CLASS_OPTIONS = ["Daud", "Daniel", "Paulus", "Ester", "Pos PI Abraham", "Pos PI Timotius"];

        const formatTime = (timestamp) => {
            if (!timestamp) return '-';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
        };

        const formatDate = (timestamp) => {
            if (!timestamp) return '-';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
        };

        const playSound = (type) => {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;
                const ctx = new AudioContext();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                if (type === 'success') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(800, ctx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(1200, ctx.currentTime + 0.1);
                    gain.gain.setValueAtTime(0.3, ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
                    osc.start(); osc.stop(ctx.currentTime + 0.5);
                } else {
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(150, ctx.currentTime);
                    osc.frequency.linearRampToValueAtTime(100, ctx.currentTime + 0.3);
                    gain.gain.setValueAtTime(0.3, ctx.currentTime);
                    gain.gain.linearRampToValueAtTime(0.01, ctx.currentTime + 0.3);
                    osc.start(); osc.stop(ctx.currentTime + 0.3);
                }
            } catch (e) {}
        };

        const ParticipantAnalysis = ({ participants, onClose }) => {
            const [filterKelas, setFilterKelas] = React.useState('SEMUA');
            const [filterStatus, setFilterStatus] = React.useState('SEMUA');
            const [search, setSearch] = React.useState('');
            const [viewMode, setViewMode] = React.useState('list'); 

            const modalPieRef = React.useRef(null);
            const modalBarRef = React.useRef(null);
            const modalLineRef = React.useRef(null);
            const chartInstancePie = React.useRef(null);
            const chartInstanceBar = React.useRef(null);
            const chartInstanceLine = React.useRef(null);

            const uniqueClasses = ['SEMUA', ...new Set(participants.map(p => p.kelas || 'Tanpa Kelas'))].sort();
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agt', 'Sep', 'Okt', 'Nov', 'Des'];

            const filteredData = React.useMemo(() => {
                return participants.filter(p => {
                    const kelasMatch = filterKelas === 'SEMUA' || (p.kelas || 'Tanpa Kelas') === filterKelas;
                    const statusMatch = filterStatus === 'SEMUA' || (filterStatus === 'HADIR' && p.checkedIn) || (filterStatus === 'BELUM' && !p.checkedIn);
                    const searchMatch = p.name.toLowerCase().includes(search.toLowerCase()) || p.regNum.toLowerCase().includes(search.toLowerCase());
                    return kelasMatch && statusMatch && searchMatch;
                });
            }, [participants, filterKelas, filterStatus, search]);

            const stats = { total: filteredData.length, hadir: filteredData.filter(p => p.checkedIn).length, absen: filteredData.filter(p => !p.checkedIn).length };
            const persentase = stats.total > 0 ? Math.round((stats.hadir / stats.total) * 100) : 0;

            React.useEffect(() => {
                if (viewMode !== 'list') return; 
                if (chartInstancePie.current) chartInstancePie.current.destroy();
                if (chartInstanceBar.current) chartInstanceBar.current.destroy();
                if (chartInstanceLine.current) chartInstanceLine.current.destroy();

                if (modalPieRef.current) {
                    chartInstancePie.current = new Chart(modalPieRef.current, {
                        type: 'doughnut',
                        data: { labels: ['Hadir', 'Belum'], datasets: [{ data: [stats.hadir, stats.absen], backgroundColor: ['#10b981', '#f43f5e'], borderWidth: 0 }] },
                        options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'right' } } }
                    });
                }
            }, [filteredData, viewMode]);

            return (
                <div className="fixed inset-0 z-[100] bg-gray-900/50 backdrop-blur-sm flex items-center justify-center p-4 animate-fade-in no-print">
                    <div className="bg-white w-full max-w-6xl h-[95vh] rounded-3xl shadow-2xl flex flex-col overflow-hidden">
                        <div className="bg-gradient-to-r from-primary to-secondary p-5 text-white flex justify-between items-center shrink-0">
                            <div><h2 className="text-2xl font-black flex items-center gap-2"><LayoutList /> Analisa & Laporan</h2></div>
                            <button onClick={onClose} className="bg-white/20 hover:bg-white/30 p-2 rounded-full transition"><X size={24} /></button>
                        </div>
                        <div className="flex-1 overflow-auto p-6">
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                <div className="bg-white p-4 rounded-2xl border border-gray-200 shadow-sm flex flex-col h-48"><canvas ref={modalPieRef}></canvas></div>
                                <div className="bg-white p-4 rounded-2xl border border-gray-200 shadow-sm col-span-2 overflow-auto">
                                     <table className="w-full text-left text-sm">
                                        <thead><tr className="border-b"><th>Nama</th><th>Kelas</th><th>Status</th></tr></thead>
                                        <tbody>{filteredData.slice(0,50).map(p=>(<tr key={p.id} className="border-b"><td>{p.name}</td><td>{p.kelas}</td><td>{p.checkedIn ? '✅' : '❌'}</td></tr>))}</tbody>
                                     </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const StatsChart = ({ participants }) => {
            const trendRef = React.useRef(null);
            React.useEffect(() => {
                if (trendRef.current) {
                    new Chart(trendRef.current, { type: 'line', data: { labels: ['Sesi Ini'], datasets: [{ label: 'Kehadiran', data: [participants.filter(p=>p.checkedIn).length], borderColor: '#4f46e5', fill: true }] }, options: { responsive: true, maintainAspectRatio: false } });
                }
            }, [participants]);
            return (
                <div className="glass-panel p-6 rounded-3xl shadow-lg border border-white/40 mb-8">
                    <div className="h-64 w-full"><canvas ref={trendRef}></canvas></div>
                </div>
            );
        };

        const NavBar = ({ view, setView, isAdmin, isManager, isScanner }) => (
            <nav className="fixed bottom-0 left-0 w-full glass-nav shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-50 md:top-0 md:bottom-auto md:border-b md:border-t-0 no-print">
                <div className="flex justify-around items-center h-20 max-w-4xl mx-auto px-4">
                    <button onClick={() => setView('home')} className={`flex flex-col items-center transition ${view === 'home' ? 'text-primary' : 'text-gray-400'}`}><Users size={24}/><span className="text-[10px] mt-1">Beranda</span></button>
                    <button onClick={() => setView('my-qr')} className={`flex flex-col items-center transition ${view === 'my-qr' ? 'text-primary' : 'text-gray-400'}`}><QrCode size={24}/><span className="text-[10px] mt-1">QR Saya</span></button>
                    {(isAdmin || isScanner || isManager) && (<button onClick={() => setView('scanner')} className="group relative -top-6"><div className="bg-gradient-to-tr from-primary to-secondary rounded-full p-4 shadow-lg border-4 border-white"><Camera size={28} className="text-white" /></div></button>)}
                    <button onClick={() => setView('live')} className={`flex flex-col items-center transition ${view === 'live' ? 'text-primary' : 'text-gray-400'}`}><CheckCircle size={24}/><span className="text-[10px] mt-1">Live</span></button>
                    {(isAdmin || isManager) && (<button onClick={() => setView('admin')} className={`flex flex-col items-center transition ${view === 'admin' ? 'text-primary' : 'text-gray-400'}`}><Lock size={24}/><span className="text-[10px] mt-1">Admin</span></button>)}
                </div>
            </nav>
        );

        const ScannerView = ({ scanInput, setScanInput, handleCheckIn, scanStatus, scannedName, isSessionOpen, isAdmin, isManager, isScanner }) => {
            const videoRef = React.useRef(null);
            const scannerRef = React.useRef(null);
            const [cameraError, setCameraError] = React.useState(null);
            const [flashActive, setFlashActive] = React.useState(false);
            const lastScanTimeRef = React.useRef(0);

            React.useEffect(() => {
                if (!isSessionOpen && !isAdmin && !isManager) return;
                
                const initScanner = async () => {
                    if (videoRef.current && !scannerRef.current) {
                        try {
                            scannerRef.current = new QrScanner(videoRef.current, (result) => {
                                const now = Date.now();
                                if (now - lastScanTimeRef.current > 2000) {
                                    lastScanTimeRef.current = now;
                                    setFlashActive(true);
                                    setTimeout(() => setFlashActive(false), 300);
                                    handleCheckIn(typeof result === 'string' ? result : result.data);
                                }
                            }, {
                                // PERBAIKAN SCANNER LAPTOP
                                highlightScanRegion: true, // Membantu user laptop memposisikan kode
                                highlightCodeOutline: true,
                                preferredCamera: 'environment', // Akan otomatis fallback ke webcam jika di laptop
                                maxScansPerSecond: 15,
                                calculateScanRegion: (v) => {
                                    // Menggunakan area lebih besar untuk webcam laptop yang resolusinya rendah
                                    const smallestDim = Math.min(v.videoWidth, v.videoHeight);
                                    const scanRegionSize = Math.round(smallestDim * 0.8);
                                    return {
                                        x: Math.round((v.videoWidth - scanRegionSize) / 2),
                                        y: Math.round((v.videoHeight - scanRegionSize) / 2),
                                        width: scanRegionSize,
                                        height: scanRegionSize,
                                    };
                                }
                            });
                            await scannerRef.current.start();
                        } catch (e) { setCameraError("Akses Kamera Gagal"); }
                    }
                };
                initScanner();
                return () => { if (scannerRef.current) { scannerRef.current.stop(); scannerRef.current.destroy(); scannerRef.current = null; } };
            }, [handleCheckIn]);

            return (
                <div className="flex flex-col items-center justify-center min-h-[80vh] p-4 max-w-md mx-auto no-print">
                    <h2 className="text-3xl font-extrabold mb-6 text-white drop-shadow-md">Scan Absensi</h2>
                    <div className="scan-container mb-8">
                        {flashActive && <div className="scan-flash animate-flash"></div>}
                        <video ref={videoRef} className="scan-video" playsInline muted></video>
                        <div className="scan-overlay"></div>
                    </div>
                    <div className="w-full glass-panel p-2 rounded-2xl flex">
                        <input type="text" placeholder="ID Manual..." value={scanInput} onChange={(e) => setScanInput(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleCheckIn(scanInput)} className="flex-1 bg-transparent p-3 outline-none" />
                        <button onClick={() => handleCheckIn(scanInput)} className="bg-primary text-white px-6 rounded-xl font-bold">OK</button>
                    </div>
                    {scanStatus === 'success' && <div className="mt-4 p-4 bg-green-500 text-white rounded-xl font-bold animate-bounce text-center w-full">{scannedName} Berhasil!</div>}
                    {scanStatus === 'error' && <div className="mt-4 p-4 bg-red-500 text-white rounded-xl font-bold text-center w-full">Data Tidak Ditemukan</div>}
                </div>
            );
        };

        function App() {
            const [user, setUser] = React.useState(null);
            const [participants, setParticipants] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            const [view, setView] = React.useState('home');
            const [isAdmin, setIsAdmin] = React.useState(false);
            const [isManager, setIsManager] = React.useState(false);
            const [isScanner, setIsScanner] = React.useState(false);
            const [showLoginModal, setShowLoginModal] = React.useState(false);
            const [loginPin, setLoginPin] = React.useState('');
            const [isSessionOpen, setIsSessionOpen] = React.useState(true);
            const [showPrintModal, setShowPrintModal] = React.useState(false);
            const [showAnalysisModal, setShowAnalysisModal] = React.useState(false);
            const [scanStatus, setScanStatus] = React.useState('idle');
            const [scannedName, setScannedName] = React.useState('');
            const [scanInput, setScanInput] = React.useState('');
            const [myParticipantData, setMyParticipantData] = React.useState(null);
            const [myRegLogin, setMyRegLogin] = React.useState('');

            React.useEffect(() => {
                onAuthStateChanged(auth, (u) => { setUser(u); setLoading(false); });
                signInAnonymously(auth);
            }, []);

            React.useEffect(() => {
                if (!user) return;
                onSnapshot(collection(db, COLLECTION_NAME), (s) => setParticipants(s.docs.map(d => ({ id: d.id, ...d.data() }))));
            }, [user]);

            const handleCheckIn = async (regNum) => {
                const p = participants.find(p => p.regNum.toUpperCase() === regNum.trim().toUpperCase());
                if (!p || p.checkedIn) { setScanStatus('error'); playSound('error'); return; }
                await updateDoc(doc(db, COLLECTION_NAME, p.id), { checkedIn: true, checkInTime: serverTimestamp() });
                setScannedName(p.name); setScanStatus('success'); playSound('success');
                setTimeout(() => setScanStatus('idle'), 3000);
            };

            if (loading) return <div className="h-screen flex items-center justify-center text-white">Memuat...</div>;

            return (
                <div className="min-h-screen pb-24 md:pt-24 font-sans">
                    <NavBar view={view} setView={setView} isAdmin={isAdmin} isManager={isManager} isScanner={isScanner} />
                    
                    <main className="container mx-auto px-4 max-w-4xl no-print">
                        {view === 'home' && (
                            <div className="flex flex-col items-center justify-center min-h-[70vh] text-center">
                                <h1 className="text-5xl font-black text-white mb-2">Sermon GSM</h1>
                                <p className="text-indigo-200 mb-8">GKPS Tangerang</p>
                                <button onClick={() => setShowLoginModal(true)} className="bg-white/10 p-2 rounded-lg text-white text-xs">Petugas Login</button>
                            </div>
                        )}
                        {view === 'scanner' && <ScannerView handleCheckIn={handleCheckIn} scanStatus={scanStatus} scannedName={scannedName} isSessionOpen={isSessionOpen} isAdmin={isAdmin} scanInput={scanInput} setScanInput={setScanInput} />}
                        {view === 'admin' && (
                            <div className="animate-slide-up space-y-4">
                                <button onClick={() => setShowAnalysisModal(true)} className="w-full bg-blue-600 p-4 rounded-xl text-white font-bold">Laporan & Analisa Detail</button>
                                <button onClick={() => setShowPrintModal(true)} className="w-full bg-purple-600 p-4 rounded-xl text-white font-bold">Cetak Seluruh QR</button>
                                <StatsChart participants={participants} />
                            </div>
                        )}
                        {view === 'my-qr' && (
                            <div className="max-w-md mx-auto glass-panel p-8 rounded-3xl mt-10">
                                <input className="w-full p-4 border rounded-xl mb-4" placeholder="ID/Nama..." value={myRegLogin} onChange={e=>setMyRegLogin(e.target.value)} />
                                <button onClick={()=>{const found = participants.find(p=>p.regNum===myRegLogin||p.name.includes(myRegLogin)); if(found) setMyParticipantData(found);}} className="w-full bg-primary text-white p-4 rounded-xl font-bold">Cari QR</button>
                                {myParticipantData && (
                                    <div className="mt-6 text-center">
                                        <img src={`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${myParticipantData.regNum}`} className="mx-auto border-4 border-white shadow-lg" />
                                        <p className="mt-4 font-bold text-xl">{myParticipantData.name}</p>
                                    </div>
                                )}
                            </div>
                        )}
                        {view === 'live' && (
                             <div className="space-y-2 mt-4">
                                {participants.filter(p=>p.checkedIn).map(p=>(<div key={p.id} className="bg-white p-3 rounded-xl flex justify-between"><span>{p.name}</span><span className="text-emerald-500 font-bold">Hadir</span></div>))}
                             </div>
                        )}
                    </main>

                    {/* MODAL LOGIN */}
                    {showLoginModal && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4 no-print">
                            <div className="bg-white p-8 rounded-3xl w-full max-w-sm">
                                <input type="password" value={loginPin} onChange={e=>setLoginPin(e.target.value)} className="w-full p-4 border rounded-xl text-center text-2xl mb-4" placeholder="PIN" />
                                <button onClick={()=>{if(loginPin==='1234'){setIsAdmin(true); setShowLoginModal(false); setView('admin');}}} className="w-full bg-primary text-white p-4 rounded-xl font-bold">Login</button>
                                <button onClick={()=>setShowLoginModal(false)} className="w-full mt-2 text-gray-500">Batal</button>
                            </div>
                        </div>
                    )}

                    {/* PERBAIKAN MODAL PRINT PREVIEW */}
                    {showPrintModal && (
                        <div className="fixed inset-0 bg-white z-[200] overflow-auto print-screen">
                            <div className="p-4 border-b flex justify-between items-center bg-gray-100 no-print">
                                <h2 className="font-bold">Preview Cetak QR ({participants.length})</h2>
                                <div className="flex gap-2">
                                    <button onClick={() => window.print()} className="bg-primary text-white px-6 py-2 rounded-lg font-bold">CETAK</button>
                                    <button onClick={() => setShowPrintModal(false)} className="bg-gray-300 px-6 py-2 rounded-lg font-bold">TUTUP</button>
                                </div>
                            </div>
                            <div className="p-4 grid grid-cols-2 md:grid-cols-4 gap-4 bg-white text-black">
                                {participants.map(p => (
                                    <div key={p.id} className="border border-gray-300 p-4 flex flex-col items-center justify-center text-center page-break bg-white rounded-lg">
                                        <p className="font-bold text-xs mb-1 uppercase">{p.name}</p>
                                        <p className="text-[9px] text-gray-600 mb-2">{p.kelas}</p>
                                        <img 
                                            src={`https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=${p.regNum}`} 
                                            alt="QR" 
                                            className="w-24 h-24 mb-2"
                                            onLoad={(e) => e.target.style.opacity = 1}
                                        />
                                        <p className="text-[10px] font-mono font-bold bg-gray-100 px-2 py-1 rounded">{p.regNum}</p>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {showAnalysisModal && <ParticipantAnalysis participants={participants} onClose={() => setShowAnalysisModal(false)} />}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
