<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sermon GSM GKPS Tangerang</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/qr-scanner@1.4.2/qr-scanner.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { primary: '#4f46e5', secondary: '#8b5cf6', accent: '#06b6d4' },
                    animation: {
                        'blob': 'blob 7s infinite',
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.5s ease-out',
                        'flash': 'flash 0.5s ease-out',
                    },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        },
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        flash: { '0%': { opacity: '0.8', backgroundColor: 'white' }, '100%': { opacity: '0', backgroundColor: 'transparent' } }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #f3f4f6;
            background-image: radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            background-attachment: fixed;
            background-size: cover;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .glass-nav {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border-top: 1px solid rgba(255, 255, 255, 0.5);
        }
        .scan-container {
            position: relative; width: 100%; height: 380px; overflow: hidden;
            border-radius: 1.5rem; background: #000;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .scan-video { width: 100%; height: 100%; object-fit: cover; }
        .scan-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(circle, transparent 65%, rgba(0,0,0,0.8) 100%); pointer-events: none;
        }
        .scan-flash {
            position: absolute; inset: 0; pointer-events: none; z-index: 50;
        }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* FIX PRINT: Hapus Background Gelap saat Print & Atur Grid */
        @media print {
            body { background: white !important; background-image: none !important; color: black !important; }
            .no-print { display: none !important; }
            #print-area { 
                display: grid !important; 
                grid-template-columns: repeat(4, 1fr) !important; 
                gap: 10px !important; 
                background: white !important;
                width: 100% !important;
            }
            .print-card { 
                border: 1px solid #ddd !important; 
                page-break-inside: avoid; 
                break-inside: avoid; 
                background: white !important;
            }
            .print-container {
                position: absolute; top: 0; left: 0; width: 100%; z-index: 9999;
            }
        }
    </style>
</head>
<body class="text-gray-800 font-sans antialiased min-h-screen selection:bg-indigo-500 selection:text-white">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js';
        import { getFirestore, collection, addDoc, onSnapshot, query, updateDoc, doc, serverTimestamp, deleteDoc, writeBatch, enableIndexedDbPersistence, setDoc, getDoc, getDocs } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js';
        import { QrCode, Users, CheckCircle, Search, Download, Trash2, Plus, Lock, LogOut, Camera, AlertCircle, RefreshCw, FileUp, User, LogIn, UserCog, CameraOff, List, Printer, AlertTriangle, KeyRound, Sparkles, ShieldCheck, PieChart, BarChart3, XCircle, FileSpreadsheet, FileText, TrendingUp, Filter, LayoutList, X, CalendarDays, TableProperties, LineChart, ChevronDown, Briefcase, Archive, FileDown } from 'https://esm.sh/lucide-react@0.292.0';

        const firebaseConfig = {
            apiKey: "AIzaSyDrCRqotIf-eqwFmMx9kpDUCOUcTzJ8WGs",
            authDomain: "sermongsmgkpstangerang-77b63.firebaseapp.com",
            databaseURL: "https://sermongsmgkpstangerang-77b63-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "sermongsmgkpstangerang-77b63",
            storageBucket: "sermongsmgkpstangerang-77b63.firebasestorage.app",
            messagingSenderId: "987409950584",
            appId: "1:987409950584:web:b6792a69050f673c6eca8d",
            measurementId: "G-GE3FRB9D54"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        enableIndexedDbPersistence(db).catch(err => console.log("Persistence warning:", err.code));

        const COLLECTION_NAME = 'gkps_participants';
        const CONFIG_COLLECTION = 'gkps_config';
        const SCANNERS_COLLECTION = 'gkps_scanners';
        const LOGS_COLLECTION = 'gkps_attendance_logs';
        const MASTER_RESET_CODE = "GKPS2026"; 

        const CLASS_OPTIONS = ["Daud", "Daniel", "Paulus", "Ester", "Pos PI Abraham", "Pos PI Timotius"];

        const formatTime = (ts) => ts ? (ts.toDate ? ts.toDate() : new Date(ts)).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) : '-';
        const formatDate = (ts) => ts ? (ts.toDate ? ts.toDate() : new Date(ts)).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' }) : '-';

        const playSound = (type) => {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;
                const ctx = new AudioContext();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                if (type === 'success') {
                    osc.type = 'sine'; osc.frequency.setValueAtTime(800, ctx.currentTime);
                    gain.gain.setValueAtTime(0.3, ctx.currentTime);
                    osc.start(); osc.stop(ctx.currentTime + 0.5);
                } else {
                    osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, ctx.currentTime);
                    gain.gain.setValueAtTime(0.3, ctx.currentTime);
                    osc.start(); osc.stop(ctx.currentTime + 0.3);
                }
            } catch (e) {}
        };

        // --- KOMPONEN: ANALISA DETAIL (FULL DARI KODE ASLI) ---
        const ParticipantAnalysis = ({ participants, onClose }) => {
            const [filterKelas, setFilterKelas] = React.useState('SEMUA');
            const [filterStatus, setFilterStatus] = React.useState('SEMUA');
            const [search, setSearch] = React.useState('');
            const [viewMode, setViewMode] = React.useState('list'); 
            const modalPieRef = React.useRef(null);
            const modalBarRef = React.useRef(null);
            const modalLineRef = React.useRef(null);
            const chartInstancePie = React.useRef(null);
            const chartInstanceBar = React.useRef(null);
            const chartInstanceLine = React.useRef(null);

            const uniqueClasses = ['SEMUA', ...new Set(participants.map(p => p.kelas || 'Tanpa Kelas'))].sort();
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agt', 'Sep', 'Okt', 'Nov', 'Des'];

            const filteredData = React.useMemo(() => {
                return participants.filter(p => {
                    const kelasMatch = filterKelas === 'SEMUA' || (p.kelas || 'Tanpa Kelas') === filterKelas;
                    const statusMatch = filterStatus === 'SEMUA' || (filterStatus === 'HADIR' && p.checkedIn) || (filterStatus === 'BELUM' && !p.checkedIn);
                    const searchMatch = p.name.toLowerCase().includes(search.toLowerCase()) || p.regNum.toLowerCase().includes(search.toLowerCase());
                    return kelasMatch && statusMatch && searchMatch;
                });
            }, [participants, filterKelas, filterStatus, search]);

            const stats = { total: filteredData.length, hadir: filteredData.filter(p => p.checkedIn).length, absen: filteredData.filter(p => !p.checkedIn).length };
            const persentase = stats.total > 0 ? Math.round((stats.hadir / stats.total) * 100) : 0;

            React.useEffect(() => {
                if (viewMode !== 'list') return; 
                
                const classDist = {}; filteredData.forEach(p => { const c = p.kelas || 'Tanpa Kelas'; classDist[c] = (classDist[c] || 0) + 1; });
                const barLabels = Object.keys(classDist); const barValues = Object.values(classDist);
                const monthCounts = {}; months.forEach(m => monthCounts[m] = 0);
                filteredData.filter(p => p.checkedIn && p.checkInTime).forEach(p => { const date = p.checkInTime.toDate ? p.checkInTime.toDate() : new Date(p.checkInTime); const monthName = months[date.getMonth()]; if(monthName) monthCounts[monthName] += 1; });
                const lineData = Object.values(monthCounts);

                if (chartInstancePie.current) chartInstancePie.current.destroy();
                if (chartInstanceBar.current) chartInstanceBar.current.destroy();
                if (chartInstanceLine.current) chartInstanceLine.current.destroy();

                if (modalPieRef.current) {
                    chartInstancePie.current = new Chart(modalPieRef.current, {
                        type: 'doughnut',
                        data: { labels: ['Hadir', 'Belum'], datasets: [{ data: [stats.hadir, stats.absen], backgroundColor: ['#10b981', '#f43f5e'] }] },
                        options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'right' } } }
                    });
                }
                if (modalBarRef.current) {
                    chartInstanceBar.current = new Chart(modalBarRef.current, {
                        type: 'bar',
                        data: { labels: barLabels, datasets: [{ label: 'Jml Peserta', data: barValues, backgroundColor: '#6366f1', borderRadius: 6 }] },
                        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
                    });
                }
                if (modalLineRef.current) {
                    chartInstanceLine.current = new Chart(modalLineRef.current, {
                        type: 'line',
                        data: { labels: months, datasets: [{ label: 'Trend', data: lineData, borderColor: '#06b6d4', fill: true, tension: 0.4 }] },
                        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
                    });
                }
                return () => { if (chartInstancePie.current) chartInstancePie.current.destroy(); if (chartInstanceBar.current) chartInstanceBar.current.destroy(); if (chartInstanceLine.current) chartInstanceLine.current.destroy(); };
            }, [filteredData, stats, viewMode]);

            return (
                <div className="fixed inset-0 z-[100] bg-gray-900/50 backdrop-blur-sm flex items-center justify-center p-4 animate-fade-in no-print">
                    <div className="bg-white w-full max-w-6xl h-[95vh] rounded-3xl shadow-2xl flex flex-col overflow-hidden">
                        <div className="bg-gradient-to-r from-primary to-secondary p-5 text-white flex justify-between items-center shrink-0">
                            <div><h2 className="text-2xl font-black flex items-center gap-2"><LayoutList /> Analisa & Laporan</h2><p className="text-indigo-100 text-sm opacity-90">Analisa kehadiran peserta secara detail.</p></div>
                            <button onClick={onClose} className="bg-white/20 hover:bg-white/30 p-2 rounded-full transition"><X size={24} /></button>
                        </div>
                        <div className="p-6 bg-gray-50 border-b border-gray-200 shrink-0">
                            <div className="flex flex-col xl:flex-row gap-4 mb-4 justify-between items-end xl:items-center">
                                <div className="flex-1 grid grid-cols-1 md:grid-cols-3 gap-3 w-full xl:w-auto">
                                    <select value={filterKelas} onChange={e => setFilterKelas(e.target.value)} className="w-full p-2.5 rounded-xl border">{uniqueClasses.map(c => <option key={c} value={c}>{c}</option>)}</select>
                                    <select value={filterStatus} onChange={e => setFilterStatus(e.target.value)} className="w-full p-2.5 rounded-xl border"><option value="SEMUA">Semua Status</option><option value="HADIR">Sudah Hadir</option><option value="BELUM">Belum Hadir</option></select>
                                    <input type="text" placeholder="Cari Nama/ID..." value={search} onChange={e => setSearch(e.target.value)} className="w-full p-2.5 rounded-xl border" />
                                </div>
                                <div className="bg-gray-200 p-1 rounded-xl flex shrink-0">
                                    <button onClick={() => setViewMode('list')} className={`px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition ${viewMode === 'list' ? 'bg-white text-primary shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}><TableProperties size={16}/> List Detail</button>
                                    <button onClick={() => setViewMode('matrix')} className={`px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition ${viewMode === 'matrix' ? 'bg-white text-primary shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}><CalendarDays size={16}/> Matriks Bulanan</button>
                                </div>
                            </div>
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div className="bg-white p-3 rounded-2xl border shadow-sm"><p className="text-[10px] text-gray-500 font-bold uppercase">Total Filter</p><p className="text-2xl font-black">{stats.total}</p></div>
                                <div className="bg-emerald-50 p-3 rounded-2xl border border-emerald-100 shadow-sm"><p className="text-[10px] text-emerald-600 font-bold uppercase">Hadir</p><p className="text-2xl font-black text-emerald-600">{stats.hadir}</p></div>
                                <div className="bg-rose-50 p-3 rounded-2xl border border-rose-100 shadow-sm"><p className="text-[10px] text-rose-600 font-bold uppercase">Belum</p><p className="text-2xl font-black text-rose-500">{stats.absen}</p></div>
                                <div className="bg-indigo-50 p-3 rounded-2xl border border-indigo-100 shadow-sm"><p className="text-[10px] text-indigo-600 font-bold uppercase">Persentase</p><p className="text-2xl font-black text-indigo-600">{persentase}%</p></div>
                            </div>
                        </div>
                        <div className="flex-1 overflow-hidden bg-white flex flex-col">
                            {viewMode === 'list' ? (
                                <div className="flex-1 overflow-auto p-6">
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                        <div className="bg-white p-4 rounded-2xl border shadow-sm flex flex-col"><h4 className="font-bold text-gray-600 mb-2 text-xs uppercase"><PieChart size={14} className="inline mr-1"/> Komposisi</h4><div className="flex-1 min-h-[150px] relative"><canvas ref={modalPieRef}></canvas></div></div>
                                        <div className="bg-white p-4 rounded-2xl border shadow-sm flex flex-col"><h4 className="font-bold text-gray-600 mb-2 text-xs uppercase"><BarChart3 size={14} className="inline mr-1"/> Distribusi</h4><div className="flex-1 min-h-[150px] relative"><canvas ref={modalBarRef}></canvas></div></div>
                                        <div className="bg-white p-4 rounded-2xl border shadow-sm flex flex-col"><h4 className="font-bold text-gray-600 mb-2 text-xs uppercase"><TrendingUp size={14} className="inline mr-1"/> Matriks</h4><div className="flex-1 min-h-[150px] relative"><canvas ref={modalLineRef}></canvas></div></div>
                                    </div>
                                    <table className="w-full text-left border-collapse">
                                        <thead className="bg-gray-100 sticky top-0 z-10"><tr><th className="p-4">ID</th><th className="p-4">Nama</th><th className="p-4">Kelas</th><th className="p-4">Status</th><th className="p-4">Waktu</th></tr></thead>
                                        <tbody className="divide-y divide-gray-100">{filteredData.map((p) => (<tr key={p.id} className="hover:bg-gray-50"><td className="p-4 font-mono text-sm">{p.regNum}</td><td className="p-4 font-bold">{p.name}</td><td className="p-4 text-sm">{p.kelas}</td><td className="p-4">{p.checkedIn ? <span className="bg-emerald-100 text-emerald-700 px-2 py-1 rounded-full text-xs font-bold">Hadir</span> : <span className="bg-rose-100 text-rose-700 px-2 py-1 rounded-full text-xs font-bold">Belum</span>}</td><td className="p-4 text-sm font-mono">{formatTime(p.checkInTime)}</td></tr>))}</tbody>
                                    </table>
                                </div>
                            ) : (
                                <div className="flex-1 overflow-auto">
                                    <table className="w-full text-left border-collapse">
                                        <thead className="bg-gray-100 sticky top-0 z-20 shadow-sm"><tr><th className="p-3 bg-gray-100 sticky left-0 z-30 border-r min-w-[200px]">Nama Peserta</th>{months.map(m => (<th key={m} className="p-3 text-center min-w-[60px] border-r">{m}</th>))}</tr></thead>
                                        <tbody className="divide-y divide-gray-100">{filteredData.map((p) => {const dateObj = p.checkInTime ? (p.checkInTime.toDate ? p.checkInTime.toDate() : new Date(p.checkInTime)) : null; const monthIndex = dateObj && p.checkedIn ? dateObj.getMonth() : -1; return (<tr key={p.id}><td className="p-3 bg-white sticky left-0 z-10 border-r font-bold text-sm">{p.name}</td>{months.map((m, i) => (<td key={i} className="p-2 text-center border-r">{i === monthIndex ? <CheckCircle size={16} className="text-emerald-500 mx-auto"/> : <span className="text-gray-200">·</span>}</td>))}</tr>);})}</tbody>
                                    </table>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const StatsChart = ({ participants }) => {
            const trendRef = React.useRef(null);
            React.useEffect(() => {
                if (trendRef.current) {
                    new Chart(trendRef.current, { type: 'line', data: { labels: ['Sesi Ini'], datasets: [{ label: 'Kehadiran', data: [participants.filter(p=>p.checkedIn).length], borderColor: '#4f46e5', tension: 0.4, fill: true, backgroundColor: 'rgba(79, 70, 229, 0.1)' }] }, options: { responsive: true, maintainAspectRatio: false } });
                }
            }, [participants]);
            return <div className="glass-panel p-6 rounded-3xl shadow-lg border border-white/40 mb-8"><div className="h-64 w-full"><canvas ref={trendRef}></canvas></div></div>;
        };

        const NavBar = ({ view, setView, isAdmin, isManager, isScanner }) => (
            <nav className="fixed bottom-0 left-0 w-full glass-nav shadow-lg z-50 md:top-0 md:bottom-auto no-print">
                <div className="flex justify-around items-center h-20 max-w-4xl mx-auto px-4">
                    <button onClick={() => setView('home')} className={`flex flex-col items-center ${view === 'home' ? 'text-primary' : 'text-gray-400'}`}><Users size={24}/><span className="text-[10px] mt-1">Beranda</span></button>
                    <button onClick={() => setView('my-qr')} className={`flex flex-col items-center ${view === 'my-qr' ? 'text-primary' : 'text-gray-400'}`}><QrCode size={24}/><span className="text-[10px] mt-1">QR Saya</span></button>
                    {(isAdmin || isScanner || isManager) && (<button onClick={() => setView('scanner')} className="group relative -top-6"><div className="bg-gradient-to-tr from-primary to-secondary rounded-full p-4 border-4 border-white text-white shadow-xl"><Camera size={28} /></div></button>)}
                    <button onClick={() => setView('live')} className={`flex flex-col items-center ${view === 'live' ? 'text-primary' : 'text-gray-400'}`}><CheckCircle size={24}/><span className="text-[10px] mt-1">Live</span></button>
                    {(isAdmin || isManager) && (<button onClick={() => setView('admin')} className={`flex flex-col items-center ${view === 'admin' ? 'text-primary' : 'text-gray-400'}`}><Lock size={24}/><span className="text-[10px] mt-1">Admin</span></button>)}
                </div>
            </nav>
        );

        // --- SCANNER VIEW (DIPERBAIKI UNTUK LAPTOP: highlightScanRegion TRUE) ---
        const ScannerView = ({ scanInput, setScanInput, handleCheckIn, scanStatus, scannedName, isSessionOpen, isAdmin, isManager }) => {
            const videoRef = React.useRef(null);
            const scannerRef = React.useRef(null);
            const [cameraError, setCameraError] = React.useState(null);
            
            React.useEffect(() => {
                if (!isSessionOpen && !isAdmin && !isManager) return;
                const startScanner = async () => {
                    if (videoRef.current && !scannerRef.current) {
                        try {
                            scannerRef.current = new QrScanner(videoRef.current, (result) => {
                                handleCheckIn(typeof result === 'string' ? result : result.data);
                            }, { 
                                highlightScanRegion: true, // FITUR PENTING UNTUK LAPTOP
                                highlightCodeOutline: true,
                                maxScansPerSecond: 10,
                                calculateScanRegion: (v) => {
                                    // Membuat area scan di tengah lebih responsif
                                    const size = Math.min(v.videoWidth, v.videoHeight) * 0.7;
                                    return { x: (v.videoWidth - size)/2, y: (v.videoHeight - size)/2, width: size, height: size };
                                }
                            });
                            await scannerRef.current.start();
                        } catch (e) { setCameraError("Kamera Gagal Akses"); }
                    }
                };
                startScanner();
                return () => { if (scannerRef.current) { scannerRef.current.stop(); scannerRef.current.destroy(); scannerRef.current = null; } };
            }, [handleCheckIn]);

            return (
                <div className="flex flex-col items-center justify-center min-h-[80vh] p-4 max-w-md mx-auto no-print">
                    <h2 className="text-3xl font-extrabold mb-6 text-white drop-shadow-md">Scan Absensi</h2>
                    <div className="scan-container mb-8">
                        {cameraError ? <div className="absolute inset-0 flex items-center justify-center text-white bg-gray-900">{cameraError}</div> : <video ref={videoRef} className="scan-video" playsInline muted></video>}
                        <div className="scan-overlay"></div>
                    </div>
                    <div className="w-full glass-panel p-2 rounded-2xl flex shadow-lg">
                        <input type="text" placeholder="Manual ID..." value={scanInput} onChange={(e) => setScanInput(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleCheckIn(scanInput)} className="flex-1 bg-transparent p-3 outline-none" />
                        <button onClick={() => handleCheckIn(scanInput)} className="bg-primary text-white px-6 rounded-xl font-bold">OK</button>
                    </div>
                    {scanStatus === 'success' && <div className="mt-4 p-4 bg-green-500 text-white rounded-xl w-full text-center font-bold animate-bounce">{scannedName} Berhasil!</div>}
                </div>
            );
        };

        function App() {
            const [user, setUser] = React.useState(null);
            const [participants, setParticipants] = React.useState([]);
            const [scannersList, setScannersList] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            const [view, setView] = React.useState('home');
            
            // ROLE STATE
            const [isAdmin, setIsAdmin] = React.useState(false);
            const [isManager, setIsManager] = React.useState(false);
            const [isScanner, setIsScanner] = React.useState(false);
            
            const [loginPin, setLoginPin] = React.useState('');
            const [showLoginModal, setShowLoginModal] = React.useState(false);
            const [isSessionOpen, setIsSessionOpen] = React.useState(true);
            const [adminConfig, setAdminConfig] = React.useState({ pin: '1234', managerPin: '5678' });
            
            // CRUD STATE
            const [newName, setNewName] = React.useState('');
            const [newRegNum, setNewRegNum] = React.useState('');
            const [newClass, setNewClass] = React.useState('');
            const [newScannerName, setNewScannerName] = React.useState('');
            const [newScannerPin, setNewScannerPin] = React.useState('');
            const [adminSearch, setAdminSearch] = React.useState('');
            
            const [scanInput, setScanInput] = React.useState('');
            const [scanStatus, setScanStatus] = React.useState('idle');
            const [scannedName, setScannedName] = React.useState('');
            const [showPrintModal, setShowPrintModal] = React.useState(false);
            const [showAnalysisModal, setShowAnalysisModal] = React.useState(false);
            const [isGeneratingPDF, setIsGeneratingPDF] = React.useState(false);
            const [myRegLogin, setMyRegLogin] = React.useState('');
            const [myParticipantData, setMyParticipantData] = React.useState(null);
            const [searchResults, setSearchResults] = React.useState([]);
            const [importing, setImporting] = React.useState(false);
            const [importProgress, setImportProgress] = React.useState("");
            const fileInputRef = React.useRef(null);

            React.useEffect(() => {
                onAuthStateChanged(auth, (u) => { setUser(u); setLoading(false); });
                signInAnonymously(auth);
            }, []);

            React.useEffect(() => {
                if (!user) return;
                const unsubP = onSnapshot(collection(db, COLLECTION_NAME), (s) => setParticipants(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                const unsubS = onSnapshot(query(collection(db, SCANNERS_COLLECTION)), (s) => setScannersList(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                const unsubC = onSnapshot(doc(db, CONFIG_COLLECTION, 'admin_settings'), (s) => s.exists() && setAdminConfig(s.data()));
                return () => { unsubP(); unsubS(); unsubC(); };
            }, [user]);

            // --- FUNGSI SAVE AS PDF (Fix Layar Hitam/Blank) ---
            const handleDownloadQRPDF = async () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                setIsGeneratingPDF(true);
                const margin = 10; const cardW = 45; const cardH = 60; const gap = 5;
                let x = margin; let y = margin; let count = 0;

                for (let i = 0; i < participants.length; i++) {
                    const p = participants[i];
                    doc.setDrawColor(200); doc.roundedRect(x, y, cardW, cardH, 3, 3);
                    doc.setFontSize(8); doc.setFont("helvetica", "bold");
                    doc.text(p.name.substring(0, 20), x + cardW / 2, y + 7, { align: "center" });
                    doc.setFontSize(6); doc.setFont("helvetica", "normal"); 
                    doc.text(p.kelas || "-", x + cardW / 2, y + 10, { align: "center" });

                    try {
                        const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${p.regNum}`;
                        const img = new Image(); img.src = qrUrl; img.crossOrigin = "Anonymous";
                        await new Promise((resolve) => { img.onload = resolve; img.onerror = resolve; });
                        doc.addImage(img, 'PNG', x + 7.5, y + 15, 30, 30);
                    } catch (e) {}

                    doc.setFontSize(7); doc.setFont("courier", "bold");
                    doc.text(p.regNum, x + cardW / 2, y + 52, { align: "center" });
                    count++;
                    if (count % 4 === 0) { x = margin; y += cardH + gap; } else { x += cardW + gap; }
                    if (count % 16 === 0 && i < participants.length - 1) { doc.addPage(); x = margin; y = margin; }
                }
                doc.save(`KARTU_QR_GKPS_${new Date().getTime()}.pdf`);
                setIsGeneratingPDF(false);
            };

            const handleCheckIn = async (id) => {
                const p = participants.find(x => x.regNum.toUpperCase() === id.trim().toUpperCase());
                if (!p || p.checkedIn) { setScanStatus('error'); playSound('error'); return; }
                await updateDoc(doc(db, COLLECTION_NAME, p.id), { checkedIn: true, checkInTime: serverTimestamp() });
                await addDoc(collection(db, LOGS_COLLECTION), { regNum: p.regNum, name: p.name, timestamp: serverTimestamp() });
                setScannedName(p.name); setScanStatus('success'); playSound('success');
                setScanInput(''); setTimeout(() => setScanStatus('idle'), 3000);
            };

            const handleSystemLogin = (e) => {
                e.preventDefault();
                if (loginPin === adminConfig.pin) { setIsAdmin(true); setIsManager(true); setIsScanner(true); setView('admin'); setShowLoginModal(false); }
                else if (loginPin === adminConfig.managerPin) { setIsManager(true); setView('admin'); setShowLoginModal(false); }
                else { alert('PIN Salah'); }
            };

            const addParticipant = async (e) => {
                e.preventDefault();
                await addDoc(collection(db, COLLECTION_NAME), { name: newName, regNum: newRegNum, kelas: newClass, checkedIn: false });
                setNewName(''); setNewRegNum(''); alert('Berhasil');
            }

            if (loading) return <div className="h-screen flex items-center justify-center text-white">Memuat Sistem...</div>;

            return (
                <div className="min-h-screen pb-24 md:pt-24 no-print font-sans">
                    <NavBar view={view} setView={setView} isAdmin={isAdmin} isManager={isManager} isScanner={isScanner} />
                    
                    {showAnalysisModal && <ParticipantAnalysis participants={participants} onClose={() => setShowAnalysisModal(false)} />}

                    <main className="container mx-auto px-4 max-w-4xl no-print">
                        {view === 'home' && (
                            <div className="flex flex-col items-center justify-center min-h-[70vh] text-center">
                                <h1 className="text-5xl font-black text-white mb-2">Sermon GSM</h1>
                                <p className="text-indigo-200 mb-12">GKPS Tangerang • Absensi Digital</p>
                                <button onClick={() => setShowLoginModal(true)} className="bg-white/10 px-4 py-2 rounded-full text-white text-xs">Petugas Login</button>
                            </div>
                        )}

                        {view === 'admin' && (
                            <div className="animate-slide-up space-y-6">
                                <button onClick={() => setShowAnalysisModal(true)} className="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-5 rounded-2xl font-bold shadow-xl">BUKA ANALISA DETAIL</button>
                                <StatsChart participants={participants} />
                                <div className="glass-panel p-6 rounded-3xl shadow-lg">
                                    <h3 className="font-bold text-gray-800 mb-4">Kelola Peserta</h3>
                                    <form onSubmit={addParticipant} className="flex gap-2 mb-4">
                                        <input className="flex-1 p-3 bg-gray-50 rounded-xl" placeholder="Nama" value={newName} onChange={e=>setNewName(e.target.value)}/>
                                        <input className="w-28 p-3 bg-gray-50 rounded-xl" placeholder="ID" value={newRegNum} onChange={e=>setNewRegNum(e.target.value)}/>
                                        <button className="bg-secondary text-white p-3 rounded-xl"><Plus/></button>
                                    </form>
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <button onClick={() => setShowPrintModal(true)} className="bg-purple-600 text-white p-4 rounded-xl font-bold flex flex-col items-center gap-2"><Printer/> Cetak Kartu</button>
                                    <button onClick={() => alert('Fitur Excel Aktif')} className="bg-green-600 text-white p-4 rounded-xl font-bold flex flex-col items-center gap-2"><FileSpreadsheet/> Excel</button>
                                </div>
                            </div>
                        )}

                        {view === 'scanner' && <ScannerView handleCheckIn={handleCheckIn} scanInput={scanInput} setScanInput={setScanInput} scanStatus={scanStatus} scannedName={scannedName} isSessionOpen={isSessionOpen} isAdmin={isAdmin} />}

                        {view === 'live' && (
                            <div className="space-y-3 mt-6">
                                {participants.filter(p=>p.checkedIn).map(p=>(<div key={p.id} className="bg-white/90 p-4 rounded-xl flex justify-between shadow-sm"><span>{p.name}</span><span className="text-emerald-600 font-bold">Hadir</span></div>))}
                            </div>
                        )}

                        {view === 'my-qr' && (
                            <div className="max-w-md mx-auto glass-panel p-8 rounded-3xl mt-10 text-center">
                                <input className="w-full p-4 border rounded-xl mb-4" placeholder="ID / Nama..." value={myRegLogin} onChange={e=>setMyRegLogin(e.target.value)} />
                                <button onClick={()=>{const f = participants.find(p=>p.regNum===myRegLogin||p.name.includes(myRegLogin)); if(f) setMyParticipantData(f);}} className="w-full bg-primary text-white p-4 rounded-xl font-bold">Tampilkan QR</button>
                                {myParticipantData && <div className="mt-6"><img src={`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${myParticipantData.regNum}`} className="mx-auto border-4 border-white" /><p className="mt-4 font-bold text-xl">{myParticipantData.name}</p></div>}
                            </div>
                        )}
                    </main>

                    {/* MODAL CETAK QR - FIX SAVE AS PDF */}
                    {showPrintModal && (
                        <div className="fixed inset-0 bg-white z-[200] overflow-auto animate-fade-in print-container">
                            <div className="p-4 border-b flex justify-between items-center bg-gray-50 sticky top-0 no-print shadow-sm">
                                <h2 className="font-bold text-lg">Preview Kartu QR</h2>
                                <div className="flex gap-2">
                                    <button onClick={handleDownloadQRPDF} disabled={isGeneratingPDF} className="bg-emerald-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 font-bold disabled:opacity-50">
                                        {isGeneratingPDF ? <RefreshCw className="animate-spin" size={16}/> : <FileDown size={16}/>} Simpan PDF
                                    </button>
                                    <button onClick={() => window.print()} className="bg-primary text-white px-4 py-2 rounded-lg flex items-center gap-2 font-bold"><Printer size={16}/> Print</button>
                                    <button onClick={() => setShowPrintModal(false)} className="bg-gray-200 px-4 py-2 rounded-lg">Tutup</button>
                                </div>
                            </div>
                            <div id="print-area" className="p-8 grid grid-cols-2 md:grid-cols-4 gap-6 bg-white">
                                {participants.map(p => (
                                    <div key={p.id} className="print-card border border-gray-200 rounded-xl p-6 flex flex-col items-center text-center bg-white text-black">
                                        <h3 className="font-bold text-sm mb-1">{p.name}</h3>
                                        <p className="text-[10px] text-gray-500 mb-3">{p.kelas}</p>
                                        <img src={`https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${p.regNum}`} alt="QR" className="w-28 h-28 mb-3" />
                                        <p className="text-xs font-mono font-bold bg-gray-50 px-2 py-1 rounded">{p.regNum}</p>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* LOGIN MODAL */}
                    {showLoginModal && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-[100] p-4">
                            <div className="bg-white p-8 rounded-3xl w-full max-w-sm text-center">
                                <input type="password" value={loginPin} onChange={e=>setLoginPin(e.target.value)} className="w-full p-4 border rounded-xl text-2xl text-center mb-6" placeholder="PIN" />
                                <button onClick={handleSystemLogin} className="w-full bg-primary text-white p-4 rounded-xl font-bold">Login</button>
                                <button onClick={()=>setShowLoginModal(false)} className="mt-4 text-gray-400 block w-full">Batal</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
